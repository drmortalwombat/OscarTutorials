#include <c64/vic.h>
#include <c64/rasterirq.h>
#include <string.h>

char * const Screen = (char *)0x0400;
char * const Color = (char *)0xd800;

// Seven lines of mountains, split into three region, 1 line, 2 lines and 4 lines which
// will be scrolled independently
const char ParaLines[40 * 7] = 
{
	0x64,0x6F,0x20,0x4E,0xDF,0x20,0x64,0x64,0x20,0x4E,0xDF,0x20,0x64,0x6F,0x6F,0x6F,0x64,0x64,0x64,0x6F,0x4E,0xDF,0x20,0x64,0x4E,0xDF,0x20,0x64,0x6F,0x64,0x20,0x4E,0xDF,0x4E,0xDF,0x20,0x64,0x20,0x4E,0xDF,
	0xA0,0xA0,0xA0,0xA0,0xA0,0xA0,0xA0,0xA0,0xA0,0xA0,0xA0,0xA0,0xCE,0x5F,0xCE,0x5F,0xA0,0xA0,0xA0,0xA0,0xA0,0xA0,0xA0,0xA0,0xA0,0xA0,0xCE,0x5F,0xCE,0x5F,0xA0,0xA0,0xA0,0xA0,0xA0,0xCE,0x5F,0xCE,0x5F,0xA0,
	0xA0,0xE4,0xEF,0xE2,0xEF,0xE4,0xE4,0xEF,0xE4,0xCE,0x5F,0xCE,0xA0,0xE9,0xA0,0xE9,0x5F,0xCE,0x5F,0xE4,0xEF,0xEF,0xEF,0xE4,0xA0,0xCE,0xA0,0xE9,0xA0,0x20,0x5F,0xE4,0xEF,0xE4,0xCE,0xA0,0x20,0x5F,0x20,0x5F,
	0x20,0x20,0x20,0x20,0x20,0x4E,0xDF,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0xDF,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0xDF,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
	0x20,0x20,0x4E,0xDF,0x4E,0x20,0xA0,0xDF,0x4E,0xDF,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0xDF,0x4E,0x20,0xA0,0xDF,0x4E,0xDF,0x20,0x20,0x20,0x20,0x4E,0x20,0xA0,0xDF,0x20,0x20,0x4E,0xDF,0x20,0x20,
	0x20,0x4E,0x20,0xA0,0xDF,0x20,0xA0,0x69,0x20,0xA0,0xDF,0x4E,0xDF,0x20,0x20,0x4E,0xDF,0x4E,0x20,0x69,0x20,0x20,0xA0,0xA0,0xDF,0xA0,0xDF,0x4E,0xDF,0x4E,0x20,0x20,0xA0,0xA0,0xDF,0x4E,0x20,0xA0,0xDF,0x20,
	0x4E,0x20,0x20,0xA0,0xA0,0xDF,0x69,0x20,0x20,0xA0,0x69,0x20,0xA0,0xDF,0x4E,0x20,0xA0,0xDF,0x4E,0x20,0x20,0x20,0xA0,0xA0,0xA0,0xA0,0x69,0x20,0xA0,0xDF,0x20,0x20,0xA0,0xA0,0xA0,0xDF,0x20,0xA0,0xA0,0xDF
};

// Draw one line of parallax data, shifted by io bytes
void para_draw_line(char * dp, const char * sp, char io)
{
	// Source pointer to split position in source data
	const char * ssp = sp + 40 - io;
	// Copy the first part of the data
	for(char i=0; i<io; i++)
		dp[i] = ssp[i];

	// One virtual line back to copy the rest
	ssp -= 40;
	for(char i=io; i<40; i++)
		dp[i] = ssp[i];
}

// Parallax pixel offset for the three regions
unsigned sx0, sx1, sx2;

// Raster IRQs for the four zones (three parallax and one above)
RIRQCode	scroll_rirq[4];

void para_draws(void)
{
	// Draw first parallax line
	para_draw_line(Screen + 18 * 40, ParaLines + 0 * 40, sx0 >> 3);

	// Draw second and third parallax line
	para_draw_line(Screen + 19 * 40, ParaLines + 1 * 40, sx1 >> 3);
	para_draw_line(Screen + 20 * 40, ParaLines + 2 * 40, sx1 >> 3);

	// Draw final four lines
	para_draw_line(Screen + 21 * 40, ParaLines + 3 * 40, sx2 >> 3);
	para_draw_line(Screen + 22 * 40, ParaLines + 4 * 40, sx2 >> 3);
	para_draw_line(Screen + 23 * 40, ParaLines + 5 * 40, sx2 >> 3);
	para_draw_line(Screen + 24 * 40, ParaLines + 6 * 40, sx2 >> 3);
}

int main(void)
{
	// Init the raster IRQ system to use the kernal iterrupt vector
	rirq_init_kernal();

	// Upper scroll area
	rirq_build(scroll_rirq + 0, 2);
	// Change control register two with this IRQ
	rirq_write(scroll_rirq + 0, 0, &vic.ctrl2, VIC_CTRL2_CSEL);
	rirq_write(scroll_rirq + 0, 1, &vic.color_back, VCOL_BLUE);
	// Put it above the top of the screen 
	rirq_set(0, 40, scroll_rirq + 0);

	// Upper scroll area
	rirq_build(scroll_rirq + 1, 3);
	rirq_delay(scroll_rirq + 1, 11);
	// Change control register two with this IRQ
	rirq_write(scroll_rirq + 1, 1, &vic.ctrl2, 0);
	rirq_write(scroll_rirq + 1, 2, &vic.color_back, VCOL_WHITE);
	// Put it above the top of the screen 
	rirq_set(1, 49 + 18 * 8, scroll_rirq + 1);

	// Upper scroll area
	rirq_build(scroll_rirq + 2, 3);
	rirq_delay(scroll_rirq + 2, 11);
	// Change control register two with this IRQ
	rirq_write(scroll_rirq + 2, 1, &vic.ctrl2, 0);
	rirq_write(scroll_rirq + 2, 2, &vic.color_back, VCOL_MED_GREY);
	// Put it above the top of the screen 
	rirq_set(2, 49 + 19 * 8, scroll_rirq + 2);

	// Upper scroll area
	rirq_build(scroll_rirq + 3, 1);
	// Change control register two with this IRQ
	rirq_write(scroll_rirq + 3, 0, &vic.ctrl2, 0);
	// Put it above the top of the screen 
	rirq_set(3, 50 + 21 * 8, scroll_rirq + 3);

	// sort the raster IRQs
	rirq_sort();

	// start raster IRQ processing
	rirq_start();

	// Set color cells for mountains
	memset(Color + 18 * 40, VCOL_LT_GREY, 40 * 3);
	memset(Color + 21 * 40, VCOL_DARK_GREY, 40 * 4);

	// Counter to slow down farther regions
	char t = 0;
	for(;;)
	{
		// top zone moves at half pixel speed
		if (t & 1)
		{
			sx0++;
			if (sx0 >= 40 * 8) sx0 -= 40 * 8;
		}

		// center zone moves at full pixel speed
		sx1++;
		if (sx1 >= 40 * 8) sx1 -= 40 * 8;

		// bottom zone moves at double pixel speed
		sx2 += 2;
		if (sx2 >= 40 * 8) sx2 -= 40 * 8;

		// Update scroll registers in raster irq list
		rirq_data(scroll_rirq + 1, 1, sx0 & 7);
		rirq_data(scroll_rirq + 2, 1, sx1 & 7);
		rirq_data(scroll_rirq + 3, 0, sx2 & 7);

		// Draw parallax background
		para_draws();

		// Wait for next frame
		vic_waitFrame();

		t++;
	}
}
